name: Random Domain Visit

on:
#  schedule:
#    - cron: '58 3 * * *'   # ä¸­åˆ12ç‚¹å‰2åˆ†é’Ÿ (UTC+8)
#    - cron: '58 15 * * *'  # æ™šä¸Š12ç‚¹å‰2åˆ†é’Ÿ (UTC+8)
  workflow_dispatch:

jobs:
  visit-domains:
    runs-on: ubuntu-latest
    
    steps:
      - name: Random Domain Visit
        run: |
          #!/bin/bash
          set -e
          
          # åŸŸååˆ—è¡¨
          domains=(
            "ycenzh.ip-ddns.com"
            "cname.abrdns.com"
            "first.abrdns.com"
            "github.abrdns.com"
            "sakura.cloud-ip.cc"
            "ycenzh.abrdns.com"
            "ycenzh.ddns-ip.net"
          )
          
          # æµè§ˆå™¨ User-Agent åˆ—è¡¨
          user_agents=(
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36 Edg/119.0.0.0"
            "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0"
            "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.1 Safari/605.1.15"
            "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            "Mozilla/5.0 (iPhone; CPU iPhone OS 17_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.1 Mobile/15E148 Safari/604.1"
          )
          
          # éšæœºå»¶è¿Ÿ 0-240 ç§’
          delay=$((RANDOM % 241))
          echo "â° éšæœºå»¶è¿Ÿ ${delay} ç§’åå¼€å§‹è®¿é—®..."
          sleep ${delay}
          
          # éšæœºé€‰æ‹©è®¿é—® 1 æˆ– 2 ä¸ªåŸŸå
          visit_count=$((RANDOM % 2 + 1))
          echo "ğŸ¯ æœ¬æ¬¡å°†è®¿é—® ${visit_count} ä¸ªåŸŸå"
          echo ""
          
          # æ‰“ä¹±åŸŸåæ•°ç»„
          shuffled_domains=($(printf '%s\n' "${domains[@]}" | shuf))
          
          success_count=0
          fail_count=0
          
          # è®¿é—®é€‰ä¸­çš„åŸŸå
          for i in $(seq 1 ${visit_count}); do
            domain=${shuffled_domains[$((i-1))]}
            
            # éšæœºé€‰æ‹©ä¸€ä¸ª User-Agent
            ua=${user_agents[$RANDOM % ${#user_agents[@]}]}
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸŒ è®¿é—®åŸŸå #${i}: ${domain}"
            echo "ğŸ”§ User-Agent: ${ua:0:50}..."
            echo ""
            
            # å…ˆè¿›è¡Œ DNS æ£€æŸ¥
            echo "ğŸ” DNSæ£€æŸ¥..."
            if host ${domain} > /dev/null 2>&1; then
              dns_result=$(host ${domain} | head -n 1)
              echo "âœ… DNSè§£ææˆåŠŸ: ${dns_result}"
            else
              echo "âŒ DNSè§£æå¤±è´¥"
              ((fail_count++))
              continue
            fi
            
            # å°è¯• HTTPS
            echo ""
            echo "ğŸ” å°è¯• HTTPS è®¿é—®..."
            
            https_output=$(mktemp)
            https_error=$(mktemp)
            
            curl -s -L -w "\n---STATS---\nhttp_code=%{http_code}\ntime_total=%{time_total}\ntime_namelookup=%{time_namelookup}\ntime_connect=%{time_connect}\ntime_appconnect=%{time_appconnect}\nsize_download=%{size_download}" \
              -H "User-Agent: ${ua}" \
              -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8" \
              -H "Accept-Language: zh-CN,zh;q=0.9,en;q=0.8" \
              -H "Accept-Encoding: gzip, deflate, br" \
              -H "DNT: 1" \
              -H "Connection: keep-alive" \
              -H "Upgrade-Insecure-Requests: 1" \
              -H "Cache-Control: max-age=0" \
              --compressed \
              --connect-timeout 10 \
              --max-time 20 \
              -o /dev/null \
              "https://${domain}" > ${https_output} 2>${https_error}
            
            https_exit_code=$?
            
            # è§£æç»“æœ
            if [ -s ${https_output} ]; then
              http_code=$(grep "http_code=" ${https_output} | cut -d'=' -f2)
              time_total=$(grep "time_total=" ${https_output} | cut -d'=' -f2)
              time_dns=$(grep "time_namelookup=" ${https_output} | cut -d'=' -f2)
              time_connect=$(grep "time_connect=" ${https_output} | cut -d'=' -f2)
              time_ssl=$(grep "time_appconnect=" ${https_output} | cut -d'=' -f2)
              size_download=$(grep "size_download=" ${https_output} | cut -d'=' -f2)
            else
              http_code="000"
            fi
            
            # åˆ¤æ–­è®¿é—®ç»“æœ
            if [ ${https_exit_code} -eq 0 ] && [[ "${http_code}" =~ ^[2-3][0-9]{2}$ ]]; then
              echo "âœ… HTTPSè®¿é—®æˆåŠŸï¼"
              echo "   â””â”€ HTTPçŠ¶æ€ç : ${http_code}"
              echo "   â””â”€ æ€»è€—æ—¶: ${time_total}s"
              echo "   â””â”€ DNSè§£æ: ${time_dns}s | TCPè¿æ¥: ${time_connect}s | SSLæ¡æ‰‹: ${time_ssl}s"
              echo "   â””â”€ ä¸‹è½½å¤§å°: ${size_download} bytes"
              ((success_count++))
            else
              echo "âš ï¸  HTTPSè®¿é—®å¤±è´¥ (é€€å‡ºä»£ç : ${https_exit_code}, HTTP: ${http_code})"
              
              # æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
              if [ -s ${https_error} ]; then
                echo "   â””â”€ é”™è¯¯ä¿¡æ¯: $(cat ${https_error} | head -n 3 | tr '\n' ' ')"
              fi
              
              # å°è¯• HTTP
              echo ""
              echo "ğŸ”“ å›é€€åˆ° HTTP è®¿é—®..."
              
              http_output=$(mktemp)
              http_error=$(mktemp)
              
              curl -s -L -w "\n---STATS---\nhttp_code=%{http_code}\ntime_total=%{time_total}" \
                -H "User-Agent: ${ua}" \
                -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" \
                --connect-timeout 10 \
                --max-time 20 \
                -o /dev/null \
                "http://${domain}" > ${http_output} 2>${http_error}
              
              http_exit_code=$?
              
              if [ -s ${http_output} ]; then
                http_code=$(grep "http_code=" ${http_output} | cut -d'=' -f2)
                time_total=$(grep "time_total=" ${http_output} | cut -d'=' -f2)
              else
                http_code="000"
              fi
              
              if [ ${http_exit_code} -eq 0 ] && [[ "${http_code}" =~ ^[2-3][0-9]{2}$ ]]; then
                echo "âœ… HTTPè®¿é—®æˆåŠŸï¼"
                echo "   â””â”€ HTTPçŠ¶æ€ç : ${http_code}"
                echo "   â””â”€ æ€»è€—æ—¶: ${time_total}s"
                ((success_count++))
              else
                echo "âŒ HTTPè®¿é—®ä¹Ÿå¤±è´¥ (é€€å‡ºä»£ç : ${http_exit_code}, HTTP: ${http_code})"
                if [ -s ${http_error} ]; then
                  echo "   â””â”€ é”™è¯¯ä¿¡æ¯: $(cat ${http_error} | head -n 3 | tr '\n' ' ')"
                fi
                ((fail_count++))
              fi
              
              rm -f ${http_output} ${http_error}
            fi
            
            rm -f ${https_output} ${https_error}
            
            # å¦‚æœè¿˜æœ‰ä¸‹ä¸€ä¸ªåŸŸåï¼Œéšæœºç­‰å¾…
            if [ ${i} -lt ${visit_count} ]; then
              interval=$((RANDOM % 8 + 3))
              echo ""
              echo "â³ ç­‰å¾… ${interval} ç§’åè®¿é—®ä¸‹ä¸€ä¸ªåŸŸå..."
              sleep ${interval}
              echo ""
            fi
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ¨ æ‰€æœ‰è®¿é—®ä»»åŠ¡å®Œæˆï¼"
          echo "ğŸ“Š ç»Ÿè®¡: æˆåŠŸ ${success_count} | å¤±è´¥ ${fail_count}"
          echo "ğŸ“… å®Œæˆæ—¶é—´: $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')"
        shell: bash
